<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki User Details</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #343a40;
            text-align: center;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 1em;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .columns {
            display: flex;
            width: 100%;
        }

        .column {
            flex: 1;
            padding: 10px;
        }
        
        main {
            max-width: 600px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out; /* Fade-in animation */
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        label {
            margin-bottom: 10px;
            color: #007bff;
        }

        input {
            padding: 10px;
            margin-bottom: 20px;
            width: 60%;
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        #wishAnniversaryButton {
    		background-color: #007bff;
    		color: white;
    		padding: 10px 20px;
    		border: none;
    		cursor: pointer;
    		border-radius: 5px;
    		transition: background-color 0.3s ease
		}

		#wishAnniversaryButton:hover {
    		background-color: #0056b3;
		}

        #userDetails {
            margin-top: 20px;
            animation: fadeIn 0.5s ease-in-out; /* Fade-in animation */
            display: flex;
            flex-wrap: wrap;
            text-align: center;
        }
		
        #userDetails h2 {
            color: #007bff;
			text-align: center;
            margin-bottom: 10px;
        }

        #userDetails p {
            margin: 8px 0;
            
        }

        #daysToAnniversary {
            text-align: center;
            color: #007bff;
            font-weight: bold;
            margin-top: 20px;
            font-size: 20px;
			margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .autocomplete-container {
            position: relative;
            width: 60%;
            margin: 0 auto;
        }

        .autocomplete-list {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .autocomplete-item {
            padding: 15px 20px;
            cursor: pointer;
            text-align: left;
            border-bottom: 1px solid #34495e;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            color: #ecf0f1;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #34495e;
            transform: scale(1.02);
        }

        .autocomplete-item.selected {
            background-color: #3498db;
            border-left: 4px solid #2ecc71;
        }

        .autocomplete-item .username {
            font-weight: 500;
            color: #ecf0f1;
            margin-bottom: 4px;
            font-size: 1.1em;
        }

        .autocomplete-item .details {
            font-size: 0.85em;
            color: #bdc3c7;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .autocomplete-item .details::before {
            content: 'üìù';
            font-size: 1em;
        }

        #username {
            padding: 15px 20px;
            margin-bottom: 20px;
            width: 60%;
            box-sizing: border-box;
            border: 2px solid #3498db;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #fff;
            color: #2c3e50;
        }

        #username:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 0 4px rgba(46,204,113,0.2);
            transform: translateY(-2px);
        }

        /* Add a custom scrollbar */
        .autocomplete-list::-webkit-scrollbar {
            width: 8px;
        }

        .autocomplete-list::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 4px;
        }

        .autocomplete-list::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .autocomplete-list::-webkit-scrollbar-thumb:hover {
            background: #2ecc71;
        }

        /* Add animation for items */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            animation: slideIn 0.3s ease forwards;
        }

        /* Add these styles */
        #languageSelector {
            background-color: white;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #languageSelector:hover {
            background-color: #007bff;
            color: white;
        }

        #languageSelector option {
            background-color: white;
            color: #007bff;
        }

    </style>
</head>
<body>

<header>
    <div style="position: absolute; right: 20px; top: 20px;">
        <select id="languageSelector" onchange="changeLanguage()" style="padding: 5px; border-radius: 5px;">
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
            <option value="fr">Fran√ßais</option>
            <option value="de">Deutsch</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
            <option value="zh">‰∏≠Êñá</option>
        </select>
    </div>
    <h1 id="pageTitle">Wiki Anniversary (User)</h1>
</header>

<main>
    <div id="usernameInput" style="display: none;">
        <form id="userForm">
            <div class="autocomplete-container">
                <label for="username">Enter Username:</label>
                <input type="text" 
                       id="username" 
                       name="username" 
                       placeholder="Wiki Username" 
                       required 
                       oninput="handleInput(event)" 
                       onkeydown="handleKeyDown(event)">
                <div id="autocompleteList" class="autocomplete-list"></div>
            </div>
            <button type="button" onclick="getUserDetails()">Get User Details</button>
        </form>
    </div>
    
    <div class="header" id="usernameHeader"></div>
    <div id="userDetails" class="columns"></div>
    <button id="wishAnniversaryButton" style="display: none;" onclick="handleWishAnniversary()">Wish Anniversary</button>
    <div id="daysToAnniversary"></div>
    
</main>

<script>
const translations = {
    en: {
        pageTitle: "Wiki Anniversary (User)",
        enterUsername: "Enter Username:",
        getUserDetails: "Get User Details",
        registrationDate: "Registration Date:",
        totalEditCount: "Total Edit Count:",
        groups: "Groups:",
        homeWiki: "Home Wiki:",
        id: "ID:",
        rights: "Rights:",
        daysToNextAnniversary: "Days to next Anniversary:",
        wishAnniversary: "Wish Anniversary",
        userNotFound: "User not found:",
        wikiUsername: "Wiki Username"
    },
    es: {
        pageTitle: "Aniversario Wiki (Usuario)",
        enterUsername: "Ingrese nombre de usuario:",
        getUserDetails: "Obtener detalles del usuario",
        registrationDate: "Fecha de registro:",
        totalEditCount: "Total de ediciones:",
        groups: "Grupos:",
        homeWiki: "Wiki principal:",
        id: "ID:",
        rights: "Permisos:",
        daysToNextAnniversary: "D√≠as para el pr√≥ximo aniversario:",
        wishAnniversary: "Desear feliz aniversario",
        userNotFound: "Usuario no encontrado:",
        wikiUsername: "Nombre de usuario Wiki"
    },
    fr: {
        pageTitle: "Anniversaire Wiki (Utilisateur)",
        enterUsername: "Entrez le nom d'utilisateur:",
        getUserDetails: "Obtenir les d√©tails",
        registrationDate: "Date d'inscription:",
        totalEditCount: "Nombre total de modifications:",
        groups: "Groupes:",
        homeWiki: "Wiki principal:",
        id: "ID:",
        rights: "Droits:",
        daysToNextAnniversary: "Jours avant le prochain anniversaire:",
        wishAnniversary: "Souhaiter l'anniversaire",
        userNotFound: "Utilisateur non trouv√©:",
        wikiUsername: "Nom d'utilisateur Wiki"
    },
    de: {
        pageTitle: "Wiki-Jubil√§um (Benutzer)",
        enterUsername: "Benutzername eingeben:",
        getUserDetails: "Benutzerdetails abrufen",
        registrationDate: "Registrierungsdatum:",
        totalEditCount: "Gesamtzahl der Bearbeitungen:",
        groups: "Gruppen:",
        homeWiki: "Haupt-Wiki:",
        id: "ID:",
        rights: "Rechte:",
        daysToNextAnniversary: "Tage bis zum n√§chsten Jubil√§um:",
        wishAnniversary: "Jubil√§um w√ºnschen",
        userNotFound: "Benutzer nicht gefunden:",
        wikiUsername: "Wiki-Benutzername"
    },
    hi: {
        pageTitle: "‡§µ‡§ø‡§ï‡§ø ‡§µ‡§∞‡•ç‡§∑‡§ó‡§æ‡§Ç‡§† (‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ)",
        enterUsername: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:",
        getUserDetails: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç",
        registrationDate: "‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§§‡§ø‡§•‡§ø:",
        totalEditCount: "‡§ï‡•Å‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§®:",
        groups: "‡§∏‡§Æ‡•Ç‡§π:",
        homeWiki: "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§µ‡§ø‡§ï‡§ø:",
        id: "‡§Ü‡§à‡§°‡•Ä:",
        rights: "‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞:",
        daysToNextAnniversary: "‡§Ö‡§ó‡§≤‡•Ä ‡§µ‡§∞‡•ç‡§∑‡§ó‡§æ‡§Ç‡§† ‡§§‡§ï ‡§¶‡§ø‡§®:",
        wishAnniversary: "‡§µ‡§∞‡•ç‡§∑‡§ó‡§æ‡§Ç‡§† ‡§ï‡•Ä ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç",
        userNotFound: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ:",
        wikiUsername: "‡§µ‡§ø‡§ï‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ"
    },
    zh: {
        pageTitle: "Áª¥Âü∫Âë®Âπ¥ÔºàÁî®Êà∑Ôºâ",
        enterUsername: "ËæìÂÖ•Áî®Êà∑ÂêçÔºö",
        getUserDetails: "Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖ",
        registrationDate: "Ê≥®ÂÜåÊó•ÊúüÔºö",
        totalEditCount: "ÊÄªÁºñËæëÊ¨°Êï∞Ôºö",
        groups: "Áî®Êà∑ÁªÑÔºö",
        homeWiki: "‰∏ªÁª¥Âü∫Ôºö",
        id: "IDÔºö",
        rights: "ÊùÉÈôêÔºö",
        daysToNextAnniversary: "Ë∑ùÁ¶ª‰∏ã‰∏™Âë®Âπ¥ËøòÊúâÔºö",
        wishAnniversary: "Á•ùË¥∫Âë®Âπ¥",
        userNotFound: "Êú™ÊâæÂà∞Áî®Êà∑Ôºö",
        wikiUsername: "Áª¥Âü∫Áî®Êà∑Âêç"
    }
};

// Add this function to handle language changes
function changeLanguage() {
    const lang = document.getElementById('languageSelector').value;
    const texts = translations[lang];
    
    // Update all text elements
    document.getElementById('pageTitle').textContent = texts.pageTitle;
    document.querySelector('label[for="username"]').textContent = texts.enterUsername;
    document.querySelector('#username').placeholder = texts.wikiUsername;
    document.querySelector('button[onclick="getUserDetails()"]').textContent = texts.getUserDetails;
    document.getElementById('wishAnniversaryButton').textContent = texts.wishAnniversary;
    
    // If user details are already displayed, update them
    const userDetails = document.getElementById('userDetails');
    if (userDetails.innerHTML !== '') {
        updateUserDetailsLanguage(texts);
    }
}

// Add this function to update user details when language changes
function updateUserDetailsLanguage(texts) {
    const leftColumn = document.querySelector('#userDetails .column:first-child');
    const rightColumn = document.querySelector('#userDetails .column:last-child');
    
    if (leftColumn && rightColumn) {
        const registrationDateText = leftColumn.querySelector('p:nth-child(1)');
        const editCountText = leftColumn.querySelector('p:nth-child(3)');
        const groupsText = leftColumn.querySelector('p:nth-child(5)');
        
        if (registrationDateText) registrationDateText.innerHTML = `<strong>${texts.registrationDate}</strong>`;
        if (editCountText) editCountText.innerHTML = `<strong>${texts.totalEditCount}</strong>`;
        if (groupsText) groupsText.innerHTML = `<strong>${texts.groups}</strong>`;
        
        const homeWikiText = rightColumn.querySelector('p:nth-child(1)');
        const idText = rightColumn.querySelector('p:nth-child(3)');
        const rightsText = rightColumn.querySelector('p:nth-child(5)');
        
        if (homeWikiText) homeWikiText.innerHTML = `<strong>${texts.homeWiki}</strong>`;
        if (idText) idText.innerHTML = `<strong>${texts.id}</strong>`;
        if (rightsText) rightsText.innerHTML = `<strong>${texts.rights}</strong>`;
    }
    
    const daysToAnniversaryDiv = document.getElementById('daysToAnniversary');
    if (daysToAnniversaryDiv.innerHTML !== '') {
        const days = daysToAnniversaryDiv.textContent.match(/\d+/)[0];
        daysToAnniversaryDiv.innerHTML = `<strong>${texts.daysToNextAnniversary}</strong> ${days}`;
    }
}

// Modify the displayUserDetails function to use translations
function displayUserDetails(user) {
    const lang = document.getElementById('languageSelector').value;
    const texts = translations[lang];
    // ... rest of the displayUserDetails function remains the same, 
    // just update the text strings to use texts.propertyName ...
}

    setTimeout(function () {
        document.getElementById('usernameInput').style.display = 'block';

        // Check if the URL contains the username parameter
        const urlParams = new URLSearchParams(window.location.search);
        const usernameFromURL = urlParams.get('username');

        if (usernameFromURL) {
            // Set the username in the input field
            document.getElementById('username').value = usernameFromURL;

            // Trigger the user details retrieval
            getUserDetails();
        }
    }, 2000);

    function getUserDetails() {
        const username = document.getElementById('username').value;

        fetch(`https://www.mediawiki.org/w/api.php?action=query&format=json&list=&meta=globaluserinfo&utf8=1&formatversion=2&guiuser=${username}&guiprop=editcount|rights|merged|groups|unattached&origin=*`, {
            method: 'GET',
            mode: 'cors',
            jsonp: 'callback',
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayUserDetails(data.query.globaluserinfo);
                displayDaysToAnniversary(data.query.globaluserinfo.registration);
                showButtons(); // Show the additional buttons
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
            });
    }

let homewikiUrl; // Declare a variable to store the home wiki URL

async function displayUserDetails(user) {
    const userDetailsDiv = document.getElementById('userDetails');
    const usernameHeader = document.getElementById('usernameHeader');
    const daysToAnniversaryDiv = document.getElementById('daysToAnniversary');

    userDetailsDiv.innerHTML = '';
    usernameHeader.innerHTML = '';
    daysToAnniversaryDiv.innerHTML = '';

    if (user.name) {
        usernameHeader.innerHTML = `<h2>${user.name}</h2>`;

        const registrationDate = new Date(user.registration);
        const formattedDate = registrationDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const leftColumn = document.createElement('div');
        leftColumn.classList.add('column');
        leftColumn.innerHTML = `<p><strong>Registration Date:</strong></p>
                                <p>${formattedDate}</p>
                                <p><strong>Total Edit Count:</strong></p>
                                <p>${user.editcount}</p>`;

        if (user.groups.length > 0) {
            leftColumn.innerHTML += `<p><strong>Groups:</strong></p><p> ${user.groups.join(', ')}</p>`;
        }

        const rightColumn = document.createElement('div');
        rightColumn.classList.add('column');

        try {
            // Fetch homewiki URL asynchronously and store it in the variable
            homewikiUrl = await fetchHomewikiUrl(user.home, user.merged);
            rightColumn.innerHTML = `<p><strong>Home Wiki:</strong></p>
                        <p><a href="${homewikiUrl}" target="_blank">${user.home}</a></p>
                        <p><strong>ID:</strong></p>
                        <p>${user.id}</p>`;
        } catch (error) {
            console.error("Error fetching homewiki URL:", error);
            rightColumn.innerHTML = `<p><strong>Home Wiki:</strong></p>
                                    <p>Not available</p>
                                    <p><strong>Home Wiki ID:</strong></p>
                                    <p>${user.id}</p>`;
        }

        if (user.rights.length > 0) {
            rightColumn.innerHTML += `<p><strong>Rights:</strong></p><p> ${user.rights.join(', ')}</p>`;
        }

        userDetailsDiv.appendChild(leftColumn);
        userDetailsDiv.appendChild(rightColumn);

        // Call displayDaysToAnniversary with the user's registration date
        displayDaysToAnniversary(user.registration, daysToAnniversaryDiv);
    } else {
        usernameHeader.innerHTML = `<h2 style="color: red;">User not found: ${document.getElementById('username').value}</h2>`;
        daysToAnniversaryDiv.innerHTML = '';
    }
}

// Function to fetch the homewiki URL asynchronously
async function fetchHomewikiUrl(homeWiki, mergedEntries) {
    const matchingEntry = mergedEntries.find(entry => entry.wiki === homeWiki);

    if (matchingEntry) {
        return matchingEntry.url;
    } else {
        return "Not available";
    }
}

// Function to handle the click event of the wishAnniversaryButton
function handleWishAnniversary() {
    const username = document.getElementById('username').value;

    // Construct the URL using the stored homewikiUrl variable
    const anniversaryURL = `${homewikiUrl}/w/index.php?title=User_talk:${username}&action=edit&section=new`;

    // Open the URL in a new tab
    window.open(anniversaryURL, '_blank');
}

// Add event listener to the wishAnniversaryButton
document.getElementById('wishAnniversaryButton').addEventListener('click', handleWishAnniversary);

function displayDaysToAnniversary(registrationDate, daysToAnniversaryDiv) {
    const anniversaryDate = new Date(registrationDate);
    const today = new Date();

    // Create a copy of anniversaryDate to avoid modifying it directly
    const anniversaryDateCopy = new Date(anniversaryDate);

    // Set the anniversary date to the current year
    anniversaryDateCopy.setFullYear(today.getFullYear());

    // If today is the anniversary day, set it to next year
    if (today >= anniversaryDateCopy) {
        anniversaryDateCopy.setFullYear(today.getFullYear() + 1);
    }

    // Calculate the difference in days between the current date and the anniversary date
    const daysToAnniversary = Math.ceil((anniversaryDateCopy - today) / (1000 * 60 * 60 * 24));

    // Display the number of days to the next anniversary
    daysToAnniversaryDiv.innerHTML = `<strong>Days to next Anniversary:</strong> ${daysToAnniversary}`;

    if (daysToAnniversary === 0 || (daysToAnniversary < 11 || daysToAnniversary > 355)) {
        showAnniversaryNotification(daysToAnniversary);
    }

    // Call showButtons with the calculated number of days
    showButtons(daysToAnniversary);
}

function showButtons(daysToAnniversary) {
    if (daysToAnniversary < 11 || daysToAnniversary > 355) {
        document.getElementById('wishAnniversaryButton').style.display = 'inline-block';
    } else {
        document.getElementById('wishAnniversaryButton').style.display = 'none';
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        getUserDetails();
    }
}

function showAnniversaryNotification(daysToAnniversary) {
    // Check if the browser supports notifications
    if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                const username = document.getElementById('username').value;
                const anniversaryURL = `${homewikiUrl}/w/index.php?title=User_talk:${username}&action=edit&section=new`;

                let notificationMessage = '';
                let notificationUrl = '';

                if (daysToAnniversary === 0) {
                    notificationMessage = `${username}'s anniversary is today! üéâ`;
                    notificationUrl = `${homewikiUrl}/w/index.php?title=User_talk:${username}&action=edit&section=new`;
                } else if (daysToAnniversary < 11) {
                    notificationMessage = `${username}'s anniversary is in ${daysToAnniversary} day${daysToAnniversary === 1 ? '' : 's'}! üéâ`;
                    notificationUrl = `${homewikiUrl}/w/index.php?title=User_talk:${username}&action=edit&section=new`;
                } else if (daysToAnniversary > 355) {
                    notificationMessage = `${username}'s anniversary was within the past 10 days! üéâ`;
                    notificationUrl = `${homewikiUrl}/w/index.php?title=User_talk:${username}&action=edit&section=new`;
                }

                const notificationOptions = {
                    body: notificationMessage,
                };

                const notification = new Notification('Anniversary Reminder', notificationOptions);

                // Add an event listener to handle the click on the notification
                notification.addEventListener('click', () => {
                    if (notificationUrl) {
                        window.open(notificationUrl, '_blank');
                    }
                });
            }
        });
    }
}
    
  setTimeout(function () {
  document.getElementById('usernameInput').style.display = 'block';
        }, 2000);
    
function handleInput(event) {
    const query = event.target.value.trim();
    const autocompleteList = document.getElementById('autocompleteList');
    
    if (query.length < 2) {
        autocompleteList.style.display = 'none';
        return;
    }

    // Using Wikimedia's API to search for users with more comprehensive data
    const apiUrl = `https://www.mediawiki.org/w/api.php?action=query&list=allusers&auprefix=${query}&aulimit=10&auprop=editcount|registration|groups|rights&format=json&origin=*`;

    // Also search in global users
    const globalApiUrl = `https://meta.wikimedia.org/w/api.php?action=query&list=globalallusers&aguprefix=${query}&agulimit=10&aguprop=editcount|registration|groups&format=json&origin=*`;

    Promise.all([
        fetch(apiUrl).then(response => response.json()),
        fetch(globalApiUrl).then(response => response.json())
    ])
    .then(([localData, globalData]) => {
        let users = [];
        
        // Combine local and global users
        if (localData.query && localData.query.allusers) {
            users = users.concat(localData.query.allusers.map(user => ({
                ...user,
                source: 'local'
            })));
        }
        
        if (globalData.query && globalData.query.globalallusers) {
            users = users.concat(globalData.query.globalallusers.map(user => ({
                ...user,
                source: 'global'
            })));
        }

        // Remove duplicates and sort by edit count
        users = Array.from(new Set(users.map(user => user.name)))
            .map(name => users.find(user => user.name === name))
            .sort((a, b) => (b.editcount || 0) - (a.editcount || 0));

        displayAutocompleteResults(users);
    })
    .catch(error => {
        console.error('Error:', error);
        autocompleteList.style.display = 'none';
    });
}

function displayAutocompleteResults(users) {
    const autocompleteList = document.getElementById('autocompleteList');
    const query = document.getElementById('username').value.trim();
    autocompleteList.innerHTML = '';

    if (users.length === 0) {
        autocompleteList.style.display = 'none';
        return;
    }

    users.forEach(user => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        
        // Create username element with highlighting
        const usernameDiv = document.createElement('div');
        usernameDiv.className = 'username';
        const username = user.name;
        const lowerUsername = username.toLowerCase();
        const lowerQuery = query.toLowerCase();
        const index = lowerUsername.indexOf(lowerQuery);
        
        if (index >= 0) {
            const before = username.slice(0, index);
            const match = username.slice(index, index + query.length);
            const after = username.slice(index + query.length);
            usernameDiv.innerHTML = `${before}<strong style="color: #2ecc71">${match}</strong>${after}`;
        } else {
            usernameDiv.textContent = username;
        }

        // Create details element with more user information
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'details';
        
        const editCount = user.editcount ? 
            `${user.editcount.toLocaleString()} edits` : 'No edits';
        
        const registrationDate = user.registration ? 
            new Date(user.registration).toLocaleDateString() : 'Unknown registration';
        
        const userGroups = user.groups ? 
            user.groups.slice(0, 3).join(', ') : '';
        
        const userSource = user.source === 'global' ? 'üåê' : 'üìù';

        detailsDiv.innerHTML = `
            <span>${userSource} ${editCount}</span>
            <span>üìÖ ${registrationDate}</span>
            ${userGroups ? `<span>üë• ${userGroups}</span>` : ''}
        `;

        item.appendChild(usernameDiv);
        item.appendChild(detailsDiv);
        
        item.onclick = () => {
            document.getElementById('username').value = user.name;
            autocompleteList.style.display = 'none';
            getUserDetails();
        };

        autocompleteList.appendChild(item);
    });

    autocompleteList.style.display = 'block';
}

function handleKeyDown(event) {
    const autocompleteList = document.getElementById('autocompleteList');
    const items = autocompleteList.getElementsByClassName('autocomplete-item');
    let selectedItem = autocompleteList.querySelector('.autocomplete-item.selected');
    let selectedIndex = Array.from(items).indexOf(selectedItem);

    if (items.length === 0) return;

    if (event.key === 'ArrowDown') {
        event.preventDefault();
        selectedIndex = (selectedIndex + 1) % items.length;
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
    } else if (event.key === 'Enter' && selectedItem) {
        event.preventDefault();
        selectedItem.click();
        return;
    } else {
        return;
    }

    Array.from(items).forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('selected');
        }
    });
}

// Close autocomplete list when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.matches('#username')) {
        document.getElementById('autocompleteList').style.display = 'none';
    }
});
</script>

</body>
</html>